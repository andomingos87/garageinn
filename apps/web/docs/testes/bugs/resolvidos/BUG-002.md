# BUG-002: Erro ao enviar convite ao criar usuário

## Informações
- **Data:** 15/01/2026
- **Teste:** ADM-010
- **Usuário Testado:** Administrador (admin@garageinn.com.br)
- **Executor:** GPT-5.2 Codex

## Comportamento Esperado
Criar usuário com sucesso e enviar convite por email.

## Comportamento Atual
Ao clicar em **Criar Usuário**, o sistema exibe a mensagem **"Erro ao enviar convite"** e o usuário não é criado.

## Passos para Reproduzir
1. Fazer login como admin.
2. Ir em `Usuários` → `Novo Usuário`.
3. Preencher nome, email, telefone, CPF, selecionar cargo e unidade.
4. Clicar em **Criar Usuário**.

## Evidências
- Screenshot: `.playwright-mcp/bug-002-adm-010-criar-usuario-convite.png`

## Observações
O erro ocorre mesmo com dados válidos e cargo/unidade selecionados.

---

## Resolução

**Status:** ✅ Corrigido  
**Data:** 17/01/2026

### Causa Raiz

A Edge Function `invite-user` **não existia** no sistema. O código em `usuarios/novo/actions.ts` tentava chamar uma função que nunca foi criada:

```typescript
// actions.ts chamava:
const response = await fetch(`${supabaseUrl}/functions/v1/invite-user`, { ... })
// Mas a função não existia!
```

### Correção Aplicada

Criada nova Edge Function `supabase/functions/invite-user/index.ts` que:

1. **Valida autenticação** do usuário chamador
2. **Verifica permissões** (Administrador, Desenvolvedor, Diretor, ou RH)
3. **Valida dados de entrada** (email e nome obrigatórios)
4. **Verifica duplicidade** de email
5. **Envia convite** via `supabase.auth.admin.inviteUserByEmail()`
6. **Cria registro** em `profiles` com status `pending`
7. **Vincula roles** em `user_roles` (se fornecidas)
8. **Registra auditoria** em `audit_logs`

### Arquivos Criados

- `supabase/functions/invite-user/index.ts`

### Dependências

Para funcionar corretamente, é necessário:
1. Configurar SMTP no Supabase Dashboard
2. Fazer deploy da Edge Function: `supabase functions deploy invite-user`

### Deploy Necessário

```bash
cd supabase
supabase functions deploy invite-user
```

### Validação Final

**Data:** 17/01/2026

O deploy foi realizado via MCP Supabase e a funcionalidade foi validada:
- Login como admin@garageinn.com.br
- Acessar Usuários → Novo Usuário
- Preencher dados (Nome: "Teste Bug 002 - Validacao", Email: "teste.bug002.validacao@garageinn.com")
- Selecionar cargo "Assistente - Financeiro"
- Clicar em "Criar Usuário"
- **Resultado:** ✅ "Convite enviado com sucesso"
- Usuário criado com status "Pendente" (1 aguardando aceite)

### Evidências da Validação
- Screenshot: `.playwright-mcp/test-bug-002-passed.png`
