# BUG-011: Gerente não consegue acessar/editar Unidades

## Informações
- **Data:** 15/01/2026
- **Teste:** OPR-GER-009 (visualização) / OPR-GER-011 (edição)
- **Usuário Testado:** Gerente (Operações) - gerente_operacoes_teste@garageinn.com
- **Executor:** GPT-5.2 Codex

## Status: ✅ CORRIGIDO (17/01/2026)

## Comportamento Esperado
- Gerente deve acessar a tela de Unidades e visualizar todas as unidades ✅
- Gerente deve conseguir editar dados de uma unidade ✅

## Comportamento Atual
- **CORRIGIDO:** Ao acessar `/unidades`, a página carrega corretamente e exibe todas as unidades.
- **CORRIGIDO:** Gerente agora vê os botões de edição (dropdown com "Editar" e "Ativar/Desativar").

## Correção Aplicada

### Primeira Correção (17/01/2026)
**Problema:** A UI verificava apenas `isAdmin` para exibir botões de edição, ignorando a permissão `units:update` que o Gerente de Operações já possuía no RBAC.

**Solução:**
1. Criada função `checkCanEditUnits()` em `actions.ts` que verifica permissão `units:update`
2. Atualizada `page.tsx` para usar `canEdit` em vez de `isAdmin` para mostrar botões de edição
3. Atualizado `units-grid.tsx` e `unit-card.tsx` para usar prop `canEdit`
4. Atualizada página de detalhes `[id]/page.tsx` para permitir acesso com `units:read` e edição com `units:update`
5. Atualizada página de edição `[id]/editar/page.tsx` para usar `checkCanEditUnits()`

**Arquivos modificados:**
- `apps/web/src/app/(app)/unidades/actions.ts`
- `apps/web/src/app/(app)/unidades/page.tsx`
- `apps/web/src/app/(app)/unidades/components/units-grid.tsx`
- `apps/web/src/app/(app)/unidades/components/unit-card.tsx`
- `apps/web/src/app/(app)/unidades/[id]/page.tsx`
- `apps/web/src/app/(app)/unidades/[id]/editar/page.tsx`

### Segunda Correção (17/01/2026 - RLS)
**Problema:** As políticas RLS da tabela `units` só permitiam UPDATE para admins, bloqueando o Gerente de Operações mesmo com a permissão `units:update`.

**Solução:**
1. Criada função SQL `has_units_update_permission()` que verifica se o usuário tem permissão `units:update` baseado no RBAC
2. Criada política RLS `units_update_with_permission` que permite UPDATE para usuários com `units:update`
3. Migration `004_add_units_update_rls_policy` aplicada

**Arquivos modificados:**
- `projeto/database/migrations/004_add_units_update_rls_policy.sql` (nova migration)
- `apps/web/e2e/bug-011-gerente-editar-unidade.spec.ts` (novo teste E2E)

## Passos para Reproduzir (Verificação)
1. Fazer login como admin.
2. Personificar **Teste Gerente - Operações**.
3. Acessar `Unidades` pelo menu ou via URL `/unidades`.
4. Verificar que há botão de ações (três pontos) nos cards das unidades.
5. Clicar no dropdown e verificar opções "Ver Detalhes", "Editar", "Ativar/Desativar".
6. Acessar uma unidade e verificar botão "Editar" no header.

## Evidências
- Screenshot original: `.playwright-mcp/bug-011-gerente-sem-acesso-unidades.png`
- Screenshot reteste: `.playwright-mcp/test-gerente-unidades-page.png` (74 unidades visíveis)

## Requisito Original (OPR-GER-011)
| ID | Teste | Ação | Resultado Esperado |
|----|-------|------|-------------------|
| OPR-GER-011 | Editar unidade | Alterar dados de uma unidade | Dados salvos |

Requisito implementado com sucesso.
