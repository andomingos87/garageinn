# BUG-014: Gerente não consegue fechar chamado

## Informações
- **Data:** 15/01/2026
- **Teste:** OPR-GER-013
- **Usuário Testado:** Gerente (Operações) - gerente_operacoes_teste@garageinn.com
- **Executor:** GPT-5.2 Codex

## Status: ✅ CORRIGIDO COMPLETAMENTE (17/01/2026 - Validação final)

## Comportamento Esperado
Gerente deve conseguir fechar um chamado como resolvido após aprovação.

## Comportamento Atual (ANTES da correção)
Na tela do chamado não existia ação/botão para **fechar** o chamado para o Gerente.

## Comportamento Atual (DEPOIS da correção)
O botão "Fechar Chamado" agora aparece para:
- **Admin** (como antes)
- **Gerente** (qualquer departamento)

## Causa Raiz
A condição `showAdminCloseButton` verificava apenas `isAdmin`:

```typescript
// ANTES (incorreto)
const showAdminCloseButton = isAdmin && 
  !finalStatuses.includes(currentStatus) && 
  !allowedTransitions.includes('closed')
```

## Correção Aplicada

### Arquivos Modificados:

**Frontend:**
1. `apps/web/src/app/(app)/chamados/compras/[ticketId]/components/ticket-actions.tsx`
2. `apps/web/src/app/(app)/chamados/manutencao/[ticketId]/components/ticket-actions.tsx`
3. `apps/web/src/app/(app)/chamados/compras/[ticketId]/page.tsx`
4. `apps/web/src/app/(app)/chamados/manutencao/[ticketId]/page.tsx`

**Backend:**
5. `apps/web/src/app/(app)/chamados/compras/actions.ts` - Adicionada função `checkIsGerente()` e atualizada `changeTicketStatus()`
6. `apps/web/src/app/(app)/chamados/manutencao/actions.ts` - Adicionada função `checkIsGerente()` e atualizada `changeTicketStatus()`

**Database:**
7. Migration `add_gerente_close_tickets_policy` - Criada função SQL `is_gerente()` e política RLS `tickets_update_gerente_close`

**Testes:**
8. `apps/web/e2e/bug-014-gerente-fechar-chamado.spec.ts` - Teste E2E criado

### Modificações:
1. Adicionada prop `userRole` à interface `TicketActionsProps`
2. Modificada a condição para incluir Gerente:

```typescript
// DEPOIS (correto)
const showCloseButton = (isAdmin || userRole === 'Gerente') && 
  !finalStatuses.includes(currentStatus) && 
  !allowedTransitions.includes('closed')
```

3. Alterado o rótulo do botão de "Fechar Chamado (Admin)" para "Fechar Chamado"
4. As páginas agora passam `currentUserRole` para o componente

## Evidências
- Screenshot da correção: `.playwright-mcp/bug-014-gerente-botao-fechar-corrigido.png`
- Screenshot do teste E2E completo: `.playwright-mcp/bug-014-gerente-fechar-chamado-sucesso.png`
- Teste E2E executado em 17/01/2026 com Playwright MCP

## Testes Realizados

### Testes Manuais
| Usuário | Botão Visível | Status |
|---------|---------------|--------|
| Admin | ✅ Sim | Correto |
| Gerente Operações | ✅ Sim | Correto (era o bug) |
| Supervisor | ❌ Não | Correto (não deve ver) |

### Teste E2E com Playwright MCP (17/01/2026)
- ✅ **Login como Admin e personificação de Gerente de Operações**: Sucesso
- ✅ **Navegação para chamado #21**: Sucesso
- ✅ **Botão "Fechar Chamado" visível**: Sucesso
- ✅ **Fechamento do chamado**: Sucesso
- ✅ **Status alterado para "Fechado"**: Sucesso
- ✅ **Campo `closed_at` preenchido no banco**: `2026-01-17 05:20:04.694+00`
- ✅ **Histórico registrado**: Sucesso
- ✅ **Screenshot capturado**: `.playwright-mcp/bug-014-gerente-fechar-chamado-sucesso.png`

## Correções Aplicadas (Validação Final)

### 1. Frontend ✅
- Prop `userRole` adicionada ao componente `TicketActions`
- Condição modificada para incluir Gerente: `(isAdmin || userRole === 'Gerente')`

### 2. Backend ✅
- Função `checkIsGerente()` criada para verificar se usuário é Gerente
- Função `changeTicketStatus()` atualizada para permitir Gerente fechar/cancelar chamados
- Aplicado em ambos os módulos: Compras e Manutenção

### 3. Políticas RLS ✅
- Função SQL `is_gerente()` criada no banco de dados
- Política RLS `tickets_update_gerente_close` criada para permitir Gerente fazer UPDATE de status para 'closed' ou 'cancelled'
- Política garante que apenas Gerentes podem fechar chamados não finais

### 4. Testes E2E ✅
- Teste E2E criado em `apps/web/e2e/bug-014-gerente-fechar-chamado.spec.ts`
- Testa fechamento de chamados de Compras e Manutenção por Gerente

## Plano de Correção
[fix-bug-014-gerente-fechar-chamados-v2.md](../../../.context/plans/fix-bug-014-gerente-fechar-chamados-v2.md)
