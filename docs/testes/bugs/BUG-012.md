# BUG-012: Gerente não consegue triar chamados

## Informações
- **Data:** 15/01/2026
- **Teste:** OPR-GER-007
- **Usuário Testado:** Gerente (Operações) - gerente_operacoes_teste@garageinn.com
- **Executor:** GPT-5.2 Codex

## Status: ✅ RESOLVIDO (17/01/2026 - Reaberto e Corrigido)

## Comportamento Esperado
Gerente deve conseguir definir prioridade e responsável na triagem de chamados em "Aguardando Triagem".

## Comportamento Atual (Após Correção)
O botão "Fazer Triagem" agora aparece corretamente para Gerentes de qualquer departamento em chamados com status "Aguardando Triagem".

## Passos para Reproduzir (Validação)
1. Fazer login como admin.
2. Personificar **Teste Gerente - Operações**.
3. Abrir um chamado em **Aguardando Triagem** (ex.: #21).
4. ✅ O card "Ações" com botão "Fazer Triagem" agora aparece.

## Evidências
- Screenshot original: `.playwright-mcp/bug-012-gerente-sem-triagem.png`
- Screenshot reteste (falha): `.playwright-mcp/test-gerente-triagem-chamado.png`
- Screenshot correção final: `.playwright-mcp/bug-012-corrigido-botao-triagem.png`
- Screenshot teste E2E (17/01/2026): `.playwright-mcp/bug-012-gerente-triagem-funcionando.png`
  - Gerente de Operações consegue ver botão "Fazer Triagem" em chamado de Compras
  - Dialog de triagem abre corretamente
  - Campos de prioridade e responsável estão acessíveis

## Causa Raiz
O componente `ticket-actions.tsx` usava short-circuit evaluation com operador `||` que impedia a verificação de `showTriageButton` quando `canManage` era `false`:

```typescript
// ANTES (PROBLEMA):
if (!canManage || (allowedTransitions.length === 0 && !showTriageButton)) {
  return null
}
```

Quando `canManage === false`, o componente retornava `null` ANTES de verificar `showTriageButton`.

## Solução Aplicada
Alterada a lógica para verificar todas as condições de forma independente:

```typescript
// DEPOIS (CORREÇÃO):
const hasManageActions = canManage && allowedTransitions.length > 0

if (!showTriageButton && !hasManageActions && !showAdminCloseButton) {
  return null
}
```

Também adicionado guard nos botões de transição:
```typescript
{canManage && allowedTransitions.map((status) => { ... })}
```

## Arquivos Corrigidos
- `apps/web/src/app/(app)/chamados/compras/[ticketId]/components/ticket-actions.tsx`
- `apps/web/src/app/(app)/chamados/manutencao/[ticketId]/components/ticket-actions.tsx`

## Arquivos que já estavam corretos
- `apps/web/src/app/(app)/chamados/rh/[ticketId]/components/rh-ticket-actions.tsx` (já usava `&&`)
- `apps/web/src/app/(app)/chamados/sinistros/[ticketId]/components/claim-status-actions.tsx` (não tem triagem)

## Plano de Implementação
- `.context/plans/fix-bug-012-gerente-triagem.md`

## Data de Resolução
17/01/2026 (Primeira correção - backend)
17/01/2026 (Segunda correção - frontend, componente ticket-actions.tsx)

## Histórico
1. **Primeira correção (17/01/2026)**: Função `canTriageTicket()` foi atualizada para incluir 'Gerente' na lista de cargos globais que podem triar.
2. **Reabertura (17/01/2026)**: Identificado que o componente `ticket-actions.tsx` tinha lógica incorreta que impedia renderização do botão mesmo com `canTriage=true`.
3. **Segunda correção (17/01/2026)**: Lógica do componente corrigida para verificar todas as condições de forma independente.

## Teste E2E
Arquivo criado: `apps/web/e2e/bug-012-gerente-triar-chamado.spec.ts`
