# BUG-015: Múltiplos departamentos com cargos sem permissões definidas no código

## Status: ✅ RESOLVIDO (17/01/2026)

## Informações
- **Data:** 15/01/2026
- **Teste:** FIN-*, RH-* (Testes do Financeiro e RH)
- **Usuário Testado:** Múltiplos cargos do Financeiro e RH
- **Executor:** Sistema automatizado
- **Severidade:** CRÍTICA
- **Data Resolução:** 17/01/2026

## Comportamento Esperado
Todos os cargos de todos os departamentos devem ter suas permissões definidas no código RBAC e funcionar conforme a hierarquia do departamento.

## Comportamento Atual
Múltiplos departamentos têm **cargos sem permissões definidas** no arquivo `apps/web/src/lib/auth/permissions.ts`.

### Departamentos Afetados

#### Financeiro (5 de 7 cargos sem permissões)
**Cargos no banco:** Auxiliar, Assistente, Analista Júnior, Analista Pleno, Analista Sênior, Supervisor, Gerente

**Cargos no código:** Auxiliar, Analista, Coordenador, Gerente

**Sem permissões:** ❌ Assistente, ❌ Analista Júnior, ❌ Analista Pleno, ❌ Analista Sênior, ❌ Supervisor

#### RH (5 de 7 cargos sem permissões)
**Cargos no banco:** Auxiliar, Assistente, Analista Júnior, Analista Pleno, Analista Sênior, Supervisor, Gerente

**Cargos no código:** Auxiliar, Analista, Coordenador, Gerente

**Sem permissões:** ❌ Assistente, ❌ Analista Júnior, ❌ Analista Pleno, ❌ Analista Sênior, ❌ Supervisor

#### Sinistros (1 de 2 cargos sem permissões)
**Cargos no banco:** Supervisor, Gerente

**Cargos no código:** Auxiliar, Analista, Coordenador, Gerente

**Sem permissões:** ❌ Supervisor

**Nota:** Cargos Auxiliar, Analista, Coordenador existem no código mas NÃO no banco!

### Resumo Geral
| Departamento | Cargos no Banco | Cargos no Código | Sem Permissões |
|--------------|-----------------|------------------|----------------|
| Financeiro | 7 | 4 | 5 (71%) |
| RH | 7 | 4 | 5 (71%) |
| Sinistros | 2 | 4 | 1 (50%) |
| **Total** | **16** | **12** | **11 (69%)** |

## Passos para Reproduzir
1. Login como admin@garageinn.com.br
2. Navegar para Usuários
3. Impersonar qualquer usuário com cargo "Assistente Financeiro", "Analista Júnior Financeiro", "Analista Pleno Financeiro", "Analista Sênior Financeiro" ou "Supervisor Financeiro"
4. Observar que o usuário não consegue acessar nenhuma funcionalidade (Dashboard pode carregar, mas Chamados e outras áreas ficam inacessíveis)

## Causa Raiz
O arquivo `apps/web/src/lib/auth/permissions.ts` define permissões usando a constante `DEPARTMENT_ROLE_PERMISSIONS`, mas os nomes dos cargos não correspondem aos cargos cadastrados no banco de dados.

```typescript
// Código atual (linha 114-132)
'Financeiro': {
    'Auxiliar': ['tickets:read'],
    'Analista': ['tickets:read', 'tickets:approve'],
    'Coordenador': ['tickets:read', 'tickets:approve'],
    'Gerente': ['tickets:read', 'tickets:approve', 'settings:read'],
}

// Deveria ser:
'Financeiro': {
    'Auxiliar': ['tickets:read'],
    'Assistente': ['tickets:read'],
    'Analista Júnior': ['tickets:read'],
    'Analista Pleno': ['tickets:read', 'tickets:execute'],
    'Analista Sênior': ['tickets:read', 'tickets:execute', 'tickets:approve'],
    'Supervisor': ['tickets:read', 'tickets:execute', 'tickets:approve'],
    'Gerente': ['tickets:read', 'tickets:execute', 'tickets:approve', 'tickets:triage', 'settings:read'],
}
```

## Impacto
- Usuários dos 5 cargos afetados não conseguem usar o sistema
- Provavelmente afeta outros departamentos com estrutura similar

## Arquivos Afetados
- `apps/web/src/lib/auth/permissions.ts`

## Correção Sugerida
1. Atualizar o mapeamento de permissões para corresponder aos cargos reais do banco
2. Verificar todos os outros departamentos para discrepâncias similares
3. Considerar criar um teste automatizado para validar que todos os cargos do banco têm permissões definidas

## Observações
Este bug foi descoberto durante a análise pré-teste do departamento Financeiro. Recomenda-se verificar imediatamente os departamentos:
- RH
- Sinistros
- Comercial
- Auditoria
- TI

Que provavelmente têm a mesma estrutura de cargos (Auxiliar, Assistente, Analista Júnior/Pleno/Sênior, Supervisor, Gerente).

---

## Resolução (17/01/2026)

### Correções Aplicadas

O arquivo `apps/web/src/lib/auth/permissions.ts` foi completamente atualizado para mapear todos os 31 cargos existentes no banco de dados:

| Departamento | Cargos Mapeados | Status |
|--------------|-----------------|--------|
| Operações | Manobrista, Encarregado, Supervisor, Gerente | ✅ |
| Compras e Manutenção | Assistente, Comprador, Gerente | ✅ |
| Financeiro | Auxiliar, Assistente, Analista Júnior/Pleno/Sênior, Supervisor, Gerente | ✅ |
| RH | Auxiliar, Assistente, Analista Júnior/Pleno/Sênior, Supervisor, Gerente | ✅ |
| TI | Analista, Gerente | ✅ |
| Comercial | Gerente | ✅ |
| Auditoria | Auditor, Gerente | ✅ |
| Sinistros | Supervisor, Gerente | ✅ |
| **Global** | Administrador, Desenvolvedor, Diretor | ✅ |

### Validação

Script de validação criado em `apps/web/scripts/validate-rbac.ts`:

```
RESULTS: 31 passed, 0 failed, 31 total
Phase 3 Tests: 4/4 passed
ALL TESTS PASSED - BUG-015 RESOLVED
```

### Arquivos Modificados
- `apps/web/src/lib/auth/permissions.ts` - Mapeamento completo de permissões
- `apps/web/src/lib/auth/__tests__/rbac.test.ts` - Testes unitários atualizados
- `apps/web/scripts/validate-rbac.ts` - Script de validação (novo)

### Plano de Implementação
Detalhes completos em: `.context/plans/fix-rbac-permissions-mapping.md`
