# BUG-006: Não é possível personificar Desenvolvedor

## Informações
- **Data:** 15/01/2026
- **Teste:** ADM-013 (fluxo para executar testes do Desenvolvedor)
- **Usuário Testado:** Administrador (admin@garageinn.com.br)
- **Executor:** GPT-5.2 Codex

## Comportamento Esperado
Admin deve conseguir personificar o usuário **Desenvolvedor** para executar a bateria ADM-001 a ADM-022.

## Comportamento Atual
O sistema bloqueia a ação e exibe a mensagem: **"Não é permitido personificar outros Administradores ou Desenvolvedores"**.

## Passos para Reproduzir
1. Fazer login como admin.
2. Ir em `Usuários`.
3. Abrir o menu do usuário **Teste Desenvolvedor - Global**.
4. Clicar em **Personificar**.

## Evidências
- Screenshot: `.playwright-mcp/bug-006-impersonacao-desenvolvedor-bloqueada.png`

## Observações
Bloqueio impede executar os testes do cargo Desenvolvedor conforme plano.

---

## Resolução

**Status:** ✅ Fechado como "By Design"  
**Data:** 17/01/2026

### Análise Técnica

Este comportamento é **intencional** e foi implementado como medida de segurança no sistema. O código da Edge Function `impersonate-user` explicitamente protege os cargos Administrador e Desenvolvedor:

```typescript
// supabase/functions/impersonate-user/index.ts
const PROTECTED_ROLES = ["Administrador", "Desenvolvedor"];

const isTargetProtected = targetRoles?.some((ur) => {
  const role = ur.role;
  return role && PROTECTED_ROLES.includes(role.name) && role.is_global;
});

if (isTargetProtected) {
  return { error: "Não é permitido personificar outros Administradores ou Desenvolvedores" };
}
```

### Justificativa de Segurança

1. **Prevenção de Escalação de Privilégios:** Desenvolvedores têm `admin:all` (acesso total ao sistema)
2. **Proteção de Contas Sensíveis:** Impedir que um admin comprometa outro admin/dev
3. **Auditoria Confiável:** Garante que ações de admins/devs sejam rastreáveis ao usuário real
4. **Princípio do Menor Privilégio:** Personificação só deve funcionar para cargos com menos permissões

### Solução para Testes

Para executar a bateria de testes do cargo Desenvolvedor (ADM-001 a ADM-022):

1. **Usar login direto** com as credenciais do usuário de teste Desenvolvedor
2. **Não usar personificação** para este cargo específico
3. As credenciais de teste devem estar documentadas no ambiente de QA

### Decisão Final

- **Não será alterado** - comportamento correto de segurança
- Atualizar documentação de testes para orientar login direto para Desenvolvedores
