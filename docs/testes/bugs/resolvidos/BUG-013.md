# BUG-013: Gerente não consegue configurar checklist

## Informações
- **Data:** 15/01/2026
- **Teste:** OPR-GER-010
- **Usuário Testado:** Gerente (Operações) - gerente_operacoes_teste@garageinn.com
- **Executor:** GPT-5.2 Codex

## Comportamento Esperado
Gerente deve acessar a configuração de checklist e criar/editar templates.

## Comportamento Atual
Ao acessar `/checklists/configurar`, a aplicação redireciona para o Dashboard.

## Passos para Reproduzir
1. Fazer login como admin.
2. Personificar **Teste Gerente - Operações**.
3. Acessar `/checklists/configurar`.

## Evidências
- Screenshot: `.playwright-mcp/bug-013-gerente-sem-configurar-checklist.png`

## Observações
Sem acesso à tela de configuração.

---

## Resolução

**Status:** ✅ Corrigido  
**Data:** 17/01/2026

### Causa Raiz

A página `/checklists/configurar` utilizava `checkIsAdmin()` para verificar acesso, que só retorna `true` para Administradores/Desenvolvedores/Diretores. O Gerente de Operações tem a permissão `checklists:configure` definida em `permissions.ts`, mas a página não verificava essa permissão.

```typescript
// Antes (incorreto)
const isAdmin = await checkIsAdmin()
if (!isAdmin) { redirect('/') }

// Depois (correto)
const canConfigure = await checkCanConfigureChecklists()
if (!canConfigure) { redirect('/') }
```

### Correção Aplicada

1. Criada nova função `checkCanConfigureChecklists()` em `actions.ts` que verifica:
   - Se é admin (caminho rápido)
   - OU se tem cargo com permissão `checklists:configure`

2. Atualizado todas as páginas de `/checklists/configurar/*`:
   - `page.tsx` (página principal)
   - `novo/page.tsx`
   - `[templateId]/page.tsx`
   - `[templateId]/editar/page.tsx`
   - `[templateId]/perguntas/page.tsx`

### Cargos com Acesso

Após a correção, os seguintes cargos podem acessar a configuração de checklists:

| Cargo | Departamento | Permissão |
|-------|--------------|-----------|
| Administrador | Global | `admin:all` |
| Desenvolvedor | Global | `admin:all` |
| Diretor | Global | `admin:all` |
| Gerente | Operações | `checklists:configure` |
| Gerente | Auditoria | `checklists:configure` |

### Arquivos Modificados

- `apps/web/src/app/(app)/checklists/configurar/actions.ts`
- `apps/web/src/app/(app)/checklists/configurar/page.tsx`
- `apps/web/src/app/(app)/checklists/configurar/novo/page.tsx`
- `apps/web/src/app/(app)/checklists/configurar/[templateId]/page.tsx`
- `apps/web/src/app/(app)/checklists/configurar/[templateId]/editar/page.tsx`
- `apps/web/src/app/(app)/checklists/configurar/[templateId]/perguntas/page.tsx`
