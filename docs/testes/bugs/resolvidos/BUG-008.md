# BUG-008: Encarregado vê chamados de outras unidades

## Status: ✅ RESOLVIDO

> **Resolvido em:** 17/01/2026  
> **Migration:** `fix_tickets_views_security_invoker`  
> **Plano:** [fix-tickets-unit-filter.md](../../../.context/plans/fix-tickets-unit-filter.md)

---

## Informações
- **Data:** 15/01/2026
- **Teste:** OPR-ENC-006
- **Usuário Testado:** Encarregado (Operações) - encarregado_operacoes_teste@garageinn.com
- **Executor:** GPT-5.2 Codex

## Comportamento Esperado
Encarregado deve ver apenas chamados da sua unidade.

## Comportamento Atual (Antes da Correção)
A listagem de chamados exibia chamados de outras unidades (ex.: UN001 - ACYR ANDRADE).

## Passos para Reproduzir
1. Fazer login como admin.
2. Personificar **Teste Encarregado - Operações**.
3. Acessar `Chamados` → `Compras`.

## Evidências
- Screenshot: `.playwright-mcp/bug-008-encarregado-ve-chamados-outras-unidades.png`

## Observações
Chamado #17 (UN001) aparecia para Encarregado indevidamente.

---

## Resolução

### Causa Raiz
A view `tickets_with_details` foi criada **sem `SECURITY INVOKER`**, o que fazia com que as políticas RLS da tabela `tickets` não fossem aplicadas às queries na view.

### Correção Aplicada
Migration `fix_tickets_views_security_invoker`:
- Recriou `tickets_with_details` com `security_invoker = true`
- Recriou `tickets_maintenance_with_details` com `security_invoker = true`

### Validação
Após a correção, a política `tickets_select_unit` é aplicada corretamente, filtrando tickets para mostrar apenas aqueles onde `unit_id` está na lista de unidades do usuário (`user_units`).
